---
- name: Ustaw fakt z wewnętrznym adresem IP
  ansible.builtin.set_fact:
    internal_ip_address: "{{ (ansible_facts.all_ipv4_addresses | default([])) | select('match', '^10\\.') | first | default(ansible_default_ipv4.address) }}"
  tags: [ cassandra ]

- name: Ustaw SELinux w tryb Permissive, aby zapobiec blokowaniu komunikacji
  ansible.posix.selinux:
    policy: targeted
    state: permissive
  tags: [ system, cassandra ]

- name: Upewnienie się, że stary, błędny plik repozytorium Cassandry jest usunięty
  ansible.builtin.file:
    path: /etc/yum.repos.d/cassandra.repo
    state: absent
  tags: [ system, cassandra, cassandra-install ]

- name: Czekaj na zwolnienie blokady dnf/yum
  ansible.builtin.wait_for:
    path: /var/cache/dnf/metadata_lock.pid
    state: absent
    timeout: 300 # Czekaj do 5 minut
    delay: 10   # Sprawdzaj co 10 sekund
  tags: [ system, cassandra, cassandra-install ]

- name: Wyczyść pamięć podręczną dnf
  ansible.builtin.command: dnf clean all
  changed_when: false
  tags: [ system, cassandra, cassandra-install ]

- name: Aktualizacja wszystkich pakietów systemowych
  ansible.builtin.dnf:
    name: '*'
    state: latest
  tags: [ system, cassandra ]

- name: Instalacja i konfiguracja chrony do synchronizacji czasu
  ansible.builtin.dnf:
    name: chrony
    state: present
  tags: [ system, cassandra ]

- name: Uruchomienie i włączenie usługi chronyd
  ansible.builtin.service:
    name: chronyd
    state: started
    enabled: yes
  tags: [ system, cassandra ]

- name: Instalacja OpenJDK 11
  ansible.builtin.dnf:
    name: java-11-openjdk-devel
    state: present
  tags: [ cassandra, cassandra-install ]

- name: Instalacja pip dla Pythona 3
  ansible.builtin.dnf:
    name: python3-pip
    state: present
  tags: [ cassandra, cassandra-install ]

- name: Instalacja sterownika Cassandra dla Pythona
  ansible.builtin.pip:
    name: cassandra-driver
    state: present
  tags: [ cassandra, cassandra-install ]

- name: Instalacja chkconfig i initscripts (dla zarządzania usługami)
  ansible.builtin.dnf:
    name:
      - chkconfig
      - initscripts
    state: present
  tags: [ system, cassandra, cassandra-install ]

- name: Dodanie poprawnego repozytorium Apache Cassandra
  ansible.builtin.yum_repository:
    name: cassandra
    description: Apache Cassandra
    baseurl: https://apache.jfrog.io/artifactory/cassandra-rpm/41x/
    gpgcheck: yes
    repo_gpgcheck: yes
    gpgkey: https://www.apache.org/dist/cassandra/KEYS
    enabled: yes
    state: present
  tags: [ cassandra, cassandra-install ]

- name: Przebudowa pamięci podręcznej dnf, aby uwzględnić nowe repozytorium
  ansible.builtin.command: dnf -y makecache --refresh
  changed_when: false
  tags: [ cassandra, cassandra-install ]

- name: Instalacja pakietu Cassandra
  ansible.builtin.dnf:
    name: cassandra
    state: present
  tags: [ cassandra, cassandra-install ]

- name: Przeładowanie demona systemd po instalacji pakietu
  ansible.builtin.command: systemctl daemon-reload
  changed_when: true # Zawsze zakładamy, że coś się zmieniło
  tags: [ cassandra, cassandra-install ]

- name: Zatrzymanie usługi Cassandra przed zmianą konfiguracji

  ansible.builtin.service:

    name: cassandra

    state: stopped

  tags: [cassandra, cassandra-configure]

  when: is_initial_cluster_setup | default(false)



- name: Wyczyść katalog danych Cassandry, aby rozwiązać konflikt nazwy klastra

  ansible.builtin.file:

    path: /var/lib/cassandra/data

    state: absent

  tags: [cassandra, cassandra-configure]

  when: is_initial_cluster_setup | default(false)



- name: Utwórz ponownie pusty katalog danych Cassandry

  ansible.builtin.file:

    path: /var/lib/cassandra/data

    state: directory

    owner: cassandra

    group: cassandra

    mode: '0755'

  tags: [cassandra, cassandra-configure]

  when: is_initial_cluster_setup | default(false)

- name: Wdrożenie pliku konfiguracyjnego cassandra.yaml z szablonu
  ansible.builtin.template:
    src: cassandra.yaml.j2
    dest: /etc/cassandra/default.conf/cassandra.yaml
    owner: cassandra
    group: cassandra
    mode: '0644'
  notify: Restart Cassandra
  tags: [ cassandra, cassandra-configure ]

- name: Wdrożenie pliku konfiguracyjnego cassandra-rackdc.properties z szablonu
  ansible.builtin.template:
    src: cassandra-rackdc.properties.j2
    dest: /etc/cassandra/default.conf/cassandra-rackdc.properties
    owner: cassandra
    group: cassandra
    mode: '0644'
  notify: Restart Cassandra
  tags: [ cassandra, cassandra-configure ]

- name: Upewnienie się, że usługa Cassandra jest włączona przy starcie
  ansible.builtin.service:
    name: cassandra
    enabled: yes
  tags: [ cassandra, cassandra-service ]

- name: Upewnienie się, że usługa Cassandra jest uruchomiona
  ansible.builtin.service:
    name: cassandra
    state: started
  tags: [ cassandra, cassandra-service ]

- name: Ustawienie PYTHONPATH dla cqlsh w całym systemie
  ansible.builtin.copy:
    content: "export PYTHONPATH=/usr/share/cassandra/pylib"
    dest: /etc/profile.d/cassandra.sh
    mode: '0644'
  tags: [ cassandra, cassandra-configure ]